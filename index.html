<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donghua 3D - Tìm Kiếm Phim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --accent: #fbbf24; --bg: #050505; }
        body { background-color: var(--bg); color: #f5f5f5; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }

        .view-container { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .movie-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .movie-card:hover { transform: translateY(-8px); }
        
        .skeleton {
            background: linear-gradient(90deg, #111 25%, #1d1d1d 50%, #111 75%);
            background-size: 200% 100%;
            animation: skeleton-move 1.5s infinite linear;
        }
        @keyframes skeleton-move {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        #page-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 999;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        #page-overlay.active { opacity: 1; pointer-events: all; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="page-overlay"></div>

    <header class="fixed top-0 w-full z-50 bg-black/80 backdrop-blur-xl border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div id="logo" class="flex items-center gap-2 cursor-pointer group">
                <div class="w-8 h-8 bg-amber-500 rounded-lg flex items-center justify-center group-hover:rotate-12 transition-transform">
                    <i data-lucide="play" class="w-5 h-5 text-black fill-current"></i>
                </div>
                <span class="text-xl font-black uppercase tracking-tighter">DONGHUA<span class="text-amber-500">3D</span></span>
            </div>
            
            <div class="flex-1 max-w-md mx-4 relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm phim (vđ: Conan)..." 
                    class="w-full bg-white/5 border border-white/10 rounded-xl py-2 pl-10 pr-4 text-sm focus:border-amber-500/50 outline-none transition-all">
            </div>
        </div>
    </header>

    <div id="app-root" class="pt-24 pb-12 min-h-screen">
        <!-- Nội dung sẽ được nạp tại đây -->
    </div>

    <script>
        const CONFIG = {
            API_LIST: "https://phimapi.com/v1/api/danh-sach/hoat-hinh",
            API_SEARCH: "https://phimapi.com/v1/api/tim-kiem?keyword=",
            API_DETAIL: "https://phimapi.com/phim/",
            IMG_BASE: "https://phimimg.com/"
        };

        const state = {
            page: 1,
            search: '',
            scrollPos: 0,
            cache: new Map(),
            isNavigating: false
        };

        const Router = {
            init() {
                document.getElementById('logo').onclick = () => {
                    state.search = '';
                    state.page = 1;
                    document.getElementById('searchInput').value = '';
                    this.navigate('/');
                };
                window.onpopstate = () => this.handleRoute();
                this.handleRoute();
            },

            async handleRoute() {
                const params = new URLSearchParams(window.location.search);
                const movieSlug = params.get('movie');
                if (movieSlug) {
                    await this.renderDetail(movieSlug);
                } else {
                    await this.renderHome();
                }
            },

            async navigate(path, slug = null) {
                if (state.isNavigating) return;
                state.isNavigating = true;

                const overlay = document.getElementById('page-overlay');
                overlay.classList.add('active');

                if (!slug) state.scrollPos = window.scrollY;

                const newUrl = slug ? `?movie=${slug}` : window.location.pathname;
                window.history.pushState({ slug }, '', newUrl);

                setTimeout(async () => {
                    if (slug) {
                        await this.renderDetail(slug);
                    } else {
                        await this.renderHome();
                        window.scrollTo({ top: state.scrollPos, behavior: 'instant' });
                    }
                    overlay.classList.remove('active');
                    state.isNavigating = false;
                }, 250);
            },

            async renderHome() {
                const root = document.getElementById('app-root');
                const isSearch = state.search.trim() !== '';
                const titleText = isSearch ? `Kết quả tìm kiếm: "${state.search}"` : "Phim Mới Cập Nhật";
                
                document.title = isSearch ? `Tìm kiếm: ${state.search}` : "Donghua 3D - Trang Chủ";
                
                root.innerHTML = `
                    <section class="view-container max-w-7xl mx-auto px-4">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-1.5 h-8 bg-amber-500 rounded-full"></div>
                            <h2 class="text-2xl font-black uppercase italic">${titleText}</h2>
                        </div>
                        <div id="movie-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
                            ${Array(12).fill('<div class="aspect-[2/3] skeleton rounded-2xl"></div>').join('')}
                        </div>
                        <div id="pagination" class="mt-12 flex justify-center gap-2"></div>
                    </section>
                `;

                // Sửa logic API ở đây: Nếu có search thì gọi API search, nếu không gọi API list
                const url = isSearch 
                    ? `${CONFIG.API_SEARCH}${encodeURIComponent(state.search)}&limit=24`
                    : `${CONFIG.API_LIST}?page=${state.page}`;

                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    // API tìm kiếm trả về cấu trúc khác một chút so với API danh sách
                    const movies = isSearch ? data.data.items : data.data.items;

                    const grid = document.getElementById('movie-grid');
                    if (!movies || movies.length === 0) {
                        grid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-500 font-bold uppercase tracking-widest">Không tìm thấy phim nào...</div>`;
                        return;
                    }

                    grid.innerHTML = movies.map(m => `
                        <div class="movie-card group cursor-pointer" onclick="Router.navigate('/movie', '${m.slug}')">
                            <div class="relative aspect-[2/3] rounded-2xl overflow-hidden border border-white/5 mb-3 bg-neutral-900 shadow-lg">
                                <img src="${m.poster_url.includes('http') ? m.poster_url : CONFIG.IMG_BASE + m.poster_url}" 
                                     class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                    <div class="w-12 h-12 bg-amber-500 rounded-full flex items-center justify-center text-black shadow-2xl scale-90 group-hover:scale-100 transition-transform">
                                        <i data-lucide="play" class="fill-current"></i>
                                    </div>
                                </div>
                            </div>
                            <h3 class="text-sm font-bold truncate group-hover:text-amber-500 transition-colors">${m.name}</h3>
                            <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-tighter">${m.origin_name}</p>
                        </div>
                    `).join('');

                    if (!isSearch) this.renderPagination(data.data.params.pagination);
                    lucide.createIcons();
                } catch (e) {
                    console.error("Lỗi API:", e);
                }
            },

            async renderDetail(slug) {
                const root = document.getElementById('app-root');
                window.scrollTo(0, 0);

                root.innerHTML = `
                    <section class="view-container max-w-7xl mx-auto px-4">
                        <button onclick="Router.navigate('/')" class="flex items-center gap-2 text-gray-500 hover:text-white mb-8 transition-colors text-xs font-black tracking-widest uppercase">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i> QUAY LẠI
                        </button>
                        <div id="detail-content">
                             <div class="grid md:grid-cols-12 gap-10 animate-pulse">
                                <div class="md:col-span-4 aspect-[2/3] skeleton rounded-3xl"></div>
                                <div class="md:col-span-8 space-y-6">
                                    <div class="h-12 w-3/4 skeleton rounded-xl"></div>
                                    <div class="h-64 w-full skeleton rounded-[2rem]"></div>
                                </div>
                            </div>
                        </div>
                    </section>
                `;

                try {
                    let data;
                    if (state.cache.has(slug)) {
                        data = state.cache.get(slug);
                    } else {
                        const res = await fetch(CONFIG.API_DETAIL + slug);
                        data = await res.json();
                        state.cache.set(slug, data);
                    }

                    const m = data.movie;
                    document.title = `${m.name} - Donghua 3D`;

                    document.getElementById('detail-content').innerHTML = `
                        <div class="grid lg:grid-cols-12 gap-10">
                            <div class="lg:col-span-4">
                                <img src="${m.poster_url}" class="w-full rounded-[2rem] shadow-2xl border border-white/10 sticky top-24">
                            </div>
                            <div class="lg:col-span-8 space-y-8">
                                <div>
                                    <h1 class="text-4xl md:text-5xl font-black mb-2">${m.name}</h1>
                                    <p class="text-amber-500 font-bold">${m.origin_name} (${m.year})</p>
                                </div>

                                <div class="space-y-4">
                                    <div class="aspect-video bg-black rounded-[2rem] overflow-hidden border border-white/5 shadow-2xl relative">
                                        <iframe id="main-player" src="" class="w-full h-full hidden" allowfullscreen></iframe>
                                        <div id="player-ui" class="absolute inset-0 flex flex-col items-center justify-center bg-neutral-900">
                                            <div class="w-16 h-16 bg-amber-500 rounded-full flex items-center justify-center text-black shadow-xl">
                                                <i data-lucide="play" class="fill-current"></i>
                                            </div>
                                            <p class="mt-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Chọn tập phim bên dưới</p>
                                        </div>
                                    </div>
                                    <div id="ep-name-display" class="text-center text-xs font-bold text-amber-500 uppercase"></div>
                                </div>

                                <div class="space-y-4">
                                    <h3 class="text-xs font-black uppercase text-gray-500 tracking-widest">Danh sách tập</h3>
                                    <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                        ${data.episodes[0].server_data.map(ep => `
                                            <button onclick="AppActions.playVideo('${ep.link_embed}', '${ep.name}')" 
                                                class="ep-btn px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/5 rounded-xl text-xs font-bold transition-all">
                                                ${ep.name}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="p-6 bg-white/[0.02] rounded-3xl border border-white/5">
                                    <h4 class="text-amber-500 font-bold mb-3 uppercase text-xs tracking-widest">Nội dung</h4>
                                    <div class="text-gray-400 text-sm leading-relaxed">${m.content}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                } catch (e) { console.error(e); }
            },

            renderPagination(p) {
                const nav = document.getElementById('pagination');
                const total = Math.ceil(p.totalItems / p.totalItemsPerPage);
                if (total <= 1) return;
                let html = '';
                for (let i = Math.max(1, state.page - 2); i <= Math.min(total, state.page + 2); i++) {
                    html += `<button onclick="AppActions.setPage(${i})" class="w-10 h-10 rounded-xl text-xs font-bold border ${state.page === i ? 'bg-amber-500 text-black' : 'bg-white/5 text-gray-400'}">${i}</button>`;
                }
                nav.innerHTML = html;
            }
        };

        const AppActions = {
            playVideo(link, name) {
                const ifr = document.getElementById('main-player');
                const ui = document.getElementById('player-ui');
                ifr.src = link;
                ifr.classList.remove('hidden');
                ui.classList.add('hidden');
                document.getElementById('ep-name-display').innerText = `Đang xem tập: ${name}`;
                
                document.querySelectorAll('.ep-btn').forEach(btn => {
                    const active = btn.innerText === name;
                    btn.className = `ep-btn px-4 py-2 border rounded-xl text-xs font-bold transition-all ${active ? 'bg-amber-500 text-black border-amber-500' : 'bg-white/5 text-gray-400 border-white/5'}`;
                });
            },
            setPage(p) {
                state.page = p;
                Router.renderHome();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // Lắng nghe tìm kiếm
        let searchT;
        document.getElementById('searchInput').oninput = (e) => {
            clearTimeout(searchT);
            searchT = setTimeout(() => {
                state.search = e.target.value;
                state.page = 1;
                // Nếu đang ở trang chi tiết, quay về trang chủ để xem kết quả
                const params = new URLSearchParams(window.location.search);
                if (params.get('movie')) {
                    Router.navigate('/');
                } else {
                    Router.renderHome();
                }
            }, 600);
        };

        window.onload = () => Router.init();
    </script>
</body>
</html>

